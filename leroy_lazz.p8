pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	p = {}
	p.x = 56
	p.y = 56
	p.facing = 1
	friend = {}
	friend.flight = false
	cur_map_x = 0
	cur_map_y = 0
	init_turn_timer = 5
	turn_timer = init_turn_timer
	arrow_array = {}
	target = nil
	player = nil
	setup_enemies()
end

function _update()
 get_move() 
 turn_timer -= 1
 update_arrows()
end

function _draw()
 cls()
 draw_map()
 draw_arrows()
 draw_player()
 debug()
end
-->8
--draw help
function draw_player()
	if p.facing == 0 then -- left
 	spr(18, p.x, p.y)
 elseif p.facing == 1 then -- right
 	spr(19, p.x, p.y)
 elseif p.facing == 2 then -- up
 	spr(21, p.x, p.y)
	elseif p.facing == 3 then -- down
 	spr(20, p.x, p.y)
 end
end

function draw_map()
 if friend.flight then
  draw_full_map()
 else 
  draw_partial_map()
 end
end

function draw_full_map()
 local x = cur_map_x
 local y = cur_map_y
 map(16*x,16*y,0,0,16,16)
end

function draw_partial_map()
 local x = cur_map_x
 local y = cur_map_y
 map(16*x+(p.x/8)-3, 16*y+(p.y/8)-3, p.x-24, p.y-24, 7, 7)
end

function draw_arrows()
 for arrow in all(arrow_array) do
  draw_arrow(arrow)
 end
end

function draw_arrow(arrow)
 local x = cur_map_x
 local y = cur_map_y
 map(16*x+(arrow.x/8)-1, 16*y+(arrow.y/8)-1, arrow.x-8, arrow.y-8, 3, 3)
 spr(arrow.sprite, arrow.x, arrow.y)
end

-->8
--player controller
function get_move()
	if btn(5) then
	 fly()
	elseif not btn(5) then 
	 land()
	 if btnp(4) then
 	 shoot()
 	elseif btnp(0) then
 	 move_left()
 	elseif btnp(1) then
 	 move_right()
 	elseif btnp(2) then
 	 move_up()
 	elseif btnp(3) then
 	 move_down()
	 end
	 update_map()
	 check_for_button()
	end
end

function fly()
 friend.flight = true
end

function land()
 friend.flight = false
end

function shoot()
 fire_arrow(p.x, p.y, p.facing)
end

function move_left()
 p.facing = 0
 if can_move(p.x-8, p.y) then
  p.x -= 8
 end
end

function move_right()
 p.facing = 1
 if can_move(p.x+8, p.y) then
  p.x += 8
 end
end

function move_up()
 p.facing = 2
 if can_move(p.x, p.y-8) then
  p.y -= 8
 end
end

function move_down()
 p.facing = 3
 if can_move(p.x, p.y+8) then
  p.y += 8 
 end
end

function can_move(x, y)
 return not is_obstacle(x, y)
end

-->8
--other controller
function fire_arrow(x, y, direction)
 local is_x = true
 local is_positive = true
 local x = p.x
 local y = p.y
 if direction == 0 then
  x-=8
 elseif direction == 1 then
  x+=8 
 elseif direction == 2 then
  y-=8 
 elseif direction == 3 then
  y+=8 
 end
 create_arrow(x, y, direction)
end

function create_arrow(x, y, direction)
 first_arrow_sprite = 48
 arrow = {}
 arrow.x = x
 arrow.y = y
 arrow.direction = direction
 arrow.dead = false
 arrow.sprite = direction+first_arrow_sprite
 add(arrow_array, arrow)
end

function update_arrows()
 for arrow in all(arrow_array) do
  local new_x = arrow.x
  local new_y = arrow.y
  if arrow.direction == 0 then
   new_x -= 8
  elseif arrow.direction == 1 then
   new_x += 8
  elseif arrow.direction == 2 then
   new_y -= 8
  elseif arrow.direction == 3 then
   new_y += 8
  end
  if arrow.dead and arrow.dead_time < 5 then
   arrow.dead_time +=1
  elseif arrow.dead and arrow.dead_time >= 5 then 
   arrow_dead(arrow, new_x, new_y)
  end
  if not get_bit(new_x, new_y, 1) then
   arrow.x = new_x
   arrow.y = new_y 
  else
   arrow_collision(arrow, new_x, new_y)
  end
 end
end

function arrow_collision(arrow, x, y) 
 if arrow.dead == false then
  arrow.dead_time = 0
  arrow.dead = true
   --play sound and do...nothing?
 end
end

function arrow_dead(arrow, x, y)
 target_pos_x = 16*(cur_map_x-1)+x/8
 target_pos_y = 16*(cur_map_y-1)+y/8
 target = mget(target_pos_x, target_pos_y)
 dir_target = index(enemy_array, target)
 if dir_target + arrow.direction == 1 or dir_target + arrow.direction == 5 then
  mset(target_pos_x, target_pos_y, 0)
 end
 del(arrow_array, arrow)
end

function delete_arrows()
 for arrow in all(arrow_array) do
  del(arrow_array, arrow)
 end
end

function update_map()
 if p.x < 0 then
  p.x = 120
  cur_map_x -= 1
  reset_map()
 end
 if p.x > 120 then
  p.x = 0
  cur_map_x += 1
  reset_map()
 end
 if p.y < 0 then
  p.y = 120
  cur_map_y -= 1
  reset_map()
 end
 if p.y > 120 then
  p.y = 0
  cur_map_y += 1
  reset_map()
 end
end

function reset_map()
 delete_arrows()
end


-->8
--helper functions

function get_bit(x, y, bit)
 local map_x = cur_map_x
 local map_y = cur_map_y
 return fget(mget(16*map_x+x/8,16*map_y+y/8),bit)
end

function is_obstacle(x, y)
 return get_bit(x, y, 1)
end

-->8
-- imani!

-- buttons!
function check_for_button()
	if is_red_button() then
		press_red()
	elseif is_blue_button() then
		press_blue()
	end
end

function press_red()
	start_row = cur_map_x*16
	start_col = cur_map_y*16
	mset(start_row+(p.x/8), start_col+(p.y/8), 8)
	for row = start_row, start_row+16 do
		for col = start_col, start_col+16 do
			if mget(row,col) == 15 then
				wall_back_red(row,col)
			elseif mget(row,col) == 10 then
				wall_gone_blue(row,col)
			elseif mget(row,col) == 6 then
				mset(row,col,5)
			end
		end
	end
end

function press_blue()
	start_row = cur_map_x*16
	start_col = cur_map_y*16
	mset(start_row+(p.x/8), start_col+(p.y/8), 6)
	for row = start_row, start_row+16 do
		for col = start_col, start_col+16 do
			if mget(row,col) == 16 then
				wall_back_blue(row,col)
			elseif mget(row,col) == 9 then
				wall_gone_red(row,col)
			elseif mget(row,col) == 8 then
				mset(row,col,7)
			end
		end
	end
end


function is_red_button()
	return get_bit(p.x,p.y,5)
end

function is_blue_button()
	return get_bit(p.x,p.y,4)
end

function wall_gone_red(row,col)
	mset(row, col, 15)
end

function wall_gone_blue(row,col)
	mset(row, col, 16)
	test = true
	row_d = row
	col_d = col
end

function wall_back_red(row,col)
	mset(row, col, 9)
end

function wall_back_blue(row,col)
	mset(row, col, 10)
end

-->8
function setup_enemies()
 enemy_array = {14, 13, 12, 11} 
end

function index(array, value)
 local iter = 0
 for i=1, #array+1 do
  if array[i] == value then
   return iter
  end
  iter+=1
 end
end

-- debug
function debug()
	print(target, 0, 0)
	print(player, 0, 10)
end

__gfx__
000000006004400600000000000000005555555500000000000000000000000000000000585858585c5c5c5c00000000066f0000044444000044444008080808
00000000600440060000400000666600500505050cccccc00cccccc0088888800888888080080805c00c0c0544446554000ff00004f7470660747f4080000000
00700700601111060000044000767600555555550c1111c00cccccc00822228008888880588888885ccccccc4ff5555047f5f55004ffff0660ffff4000000008
0007700060111106444440440d6666d0500505050c1111c00cccccc0082222800888888080080805c00c0c0547f5555044f55554045555ffff55554080000000
0007700060111106000000440fddddf0555555550c1111c00cccccc00822228008888880588888885ccccccc44f5555447f5555006555ff00ff5556000000008
0070070060000006000044400fddddf0500505050c1111c00cccccc0082222800888888080080805c00c0c0547f5f5504ff55550055555000055555080000000
00000000600000060004400000dddd00500505050cccccc00cccccc0088888800888888050080808500c0c0c000ff00044446554055555000055555000000008
00000000666666660000000000000000555555550000000000000000000000000000000085858585c5c5c5c5066f000000000000040040000004004080808080
0c0c0c0c000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c00000000089800000ffff0000ffff0000ffff0000f7f700a000000a000000000000000000000000000000000000000000000000000000000000000000000000
0000000c00899800007f7f0000f7f70000ffff0000ffff00aa6666aaaa6666aa0000000000000000000000000000000000000000000000000000000000000000
c0000000089aa9800dffffd00dffffd00d7f7fd00dffffd0aa7676aaaa7676aa0000000000000000000000000000000000000000000000000000000000000000
0000000c0897a9800fddddf00fddddf00fddddf00fddddf00a6666a0aa6666aa0000000000000000000000000000000000000000000000000000000000000000
c00000000897a9800fddddf00fddddf00fddddf00fddddf000dddd00a0dddd0a0000000000000000000000000000000000000000000000000000000000000000
0000000c008a980000dddd0000dddd0000dddd0000dddd00006dd600006dd6000000000000000000000000000000000000000000000000000000000000000000
c0c0c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000002141024204282060606064080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000404040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000050000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000090000000a000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000070000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000500090000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000004040007000a0000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000404000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040000040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404040404040000040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040000000004040404040400000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040007000b0900000e0d0000040400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040000000a040400000400000b0000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04000000000000000000000000000004040000000000000000000000000000040400000000040000000d0004000004040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040500000004000400040004000404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000000040a04040404040400000004000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000500090000000007000404040b0404040c040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000000040404040b04040404040004000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04000000000000000000000000000004040000000000000000000000000000040407000b090000040d000000000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040004000404040404000404000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040004000000000004000e00040400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040004040004040c04000400000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0400000000000000000000000000000404000000000000000000000000000004040004040000040504000400040400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040000000000000000000400000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000004040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
